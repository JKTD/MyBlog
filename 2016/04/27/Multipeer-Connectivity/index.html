<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.54.0" />



<link rel="canonical" href="http://blog.flywithme.top/2016/04/27/Multipeer-Connectivity/">


    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <title>利用Multipeer Connectivity框架进行WiFi传输 - Fly With Me</title>
    
<meta name="description" content="什么是Multipeer Connectivity 在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipee">

<meta property="og:title" content="利用Multipeer Connectivity框架进行WiFi传输 - Fly With Me">
<meta property="og:type" content="article">
<meta property="og:url" content="http://blog.flywithme.top/2016/04/27/Multipeer-Connectivity/">
<meta property="og:image" content="http://blog.flywithme.top/images/default.png">
<meta property="og:site_name" content="Fly With Me">
<meta property="og:description" content="什么是Multipeer Connectivity 在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipee">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="Fly With Me">
<meta name="twitter:url" content="http://blog.flywithme.top/2016/04/27/Multipeer-Connectivity/">
<meta name="twitter:title" content="利用Multipeer Connectivity框架进行WiFi传输 - Fly With Me">
<meta name="twitter:description" content="什么是Multipeer Connectivity 在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipee">
<meta name="twitter:image" content="http://blog.flywithme.top/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"http://blog.flywithme.top/"
    },
    "headline": "利用Multipeer Connectivity框架进行WiFi传输 - Fly With Me",
    "image": {
      "@type": "ImageObject",
      "url": "http://blog.flywithme.top/images/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2016-04-27T16:47:13JST",
    "dateModified": "2016-04-27T16:47:13JST",
    "author": {
      "@type": "Person",
      "name": "Fly With Me"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Fly With Me",
      "logo": {
        "@type": "ImageObject",
        "url": "http://blog.flywithme.top/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "什么是Multipeer Connectivity 在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipee"
  }
</script>


    <link href="http://blog.flywithme.top/css/styles.css" rel="stylesheet">
    

  </head>

  <body>
    
    
    

    <header class="l-header">
      <nav class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://blog.flywithme.top/">Fly With Me</a>
          </div>

          
          <div id="navbar" class="collapse navbar-collapse">
            
            <ul class="nav navbar-nav navbar-right">
              
              
              <li><a href="http://blog.flywithme.top/post/">归档</a></li>
              
              
              
              <li><a href="http://blog.flywithme.top/about/">关于我</a></li>
              
              
            </ul>
            
          </div>
          

        </div>
      </nav>
    </header>

    <main>
      <div class="container">
        
<div class="row">
  <div class="col-md-8">

    <nav class="p-crumb">
      <ol class="breadcrumb">
        <li><a href="http://blog.flywithme.top/"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        
        <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="http://blog.flywithme.top/post/" itemprop="url"><span itemprop="title">post</span></a></li>
        
        <li class="active">利用Multipeer Connectivity框架进行WiFi传输</li>
      </ol>
    </nav>

    <article class="single">
  <header>
    <ul class="p-facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2016-04-27T16:47:13JST">Apr 27, 2016</time></li>
      <li><i class="fa fa-bookmark" aria-hidden="true"></i><a href="http://blog.flywithme.top/post/">post</a></li>
      
    </ul>

    <h1 class="title">利用Multipeer Connectivity框架进行WiFi传输</h1>
  </header>

  

  <div class="article-body">

<h4 id="什么是multipeer-connectivity">什么是Multipeer Connectivity</h4>

<p>在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipeer Connectivity框架，即使在没有连接到WiFi（WLAN）或移动网络（xG）的情况下，距离较近的Apple设备（iMac/iPad/iPhone）之间可基于蓝牙和WiFi（P2P WiFi）技术进行发现和连接实现近场通信。</p>

<p>Multipeer Connectivity扩充的功能与利用AirDrop传输文件非常类似，可以将其看作AirDrop不能直接使用的补偿，代价是需要自己实现。</p>

<ul>
<li>本Demo主要用到4个类：<br /></li>
</ul>

<blockquote>
<p><code>MCBrowserViewController</code>:MCBrowserViewController继承自UIViewController，提供了基本的UI应用框架。</p>

<p><code>MCAdvertiserAssistant</code>、MCAdvertiserAssistant为针对Advertiser封装的管理助手,主要处理广播信息。</p>

<p><code>MCSession</code>:类似TCP链接中的socket。创建MCSession时，需指定自身MCPeerID，类似bind。</p>

<p><code>MCPeerID</code>:类似sockaddr，用于标识连接的两端endpoint，通常是昵称或设备名称。</p>
</blockquote>

<h6 id="简单地建立一个界面-主要有连接和发送2个uibutton">简单地建立一个界面，主要有连接和发送2个UIButton。</h6>

<p><img src="sources/mutipeercon/mutipeercon-SimulatorScreenShot.png" width = "200"  alt="Shcrenn shot" align=center /></p>

<h6 id="multipeer-connectivity框架初始化这4个类">Multipeer Connectivity框架初始化这4个类</h6>

<pre><code>#pragma mark - Wifi Sharing Methods
-(void)setUpMultipeer
{
    //  Setup peer ID
    self.myPeerID = [[MCPeerID alloc] initWithDisplayName:[UIDevice currentDevice].name];

    //  Setup session
    self.mySession = [[MCSession alloc] initWithPeer:self.myPeerID];
    self.mySession.delegate = self;

    //  Setup BrowserViewController
    self.browserVC = [[MCBrowserViewController alloc] initWithServiceType:@&quot;chat&quot; session:self.mySession];
    self.browserVC.delegate = self;

    //  Setup Advertiser
    self.advertiser = [[MCAdvertiserAssistant alloc] initWithServiceType:@&quot;chat&quot; discoveryInfo:nil session:self.mySession];
    [self.advertiser start];
}

-(void)showBrowserVC
{
    [self presentViewController:self.browserVC animated:YES completion:nil];
}

-(void)dismissBrowserVC
{
    [self.browserVC dismissViewControllerAnimated:YES completion:^(void){
        [self invokeAlertMethod:@&quot;连接成功&quot; Body:@&quot;Both device connected successfully.&quot; Delegate:nil];
    }];
}

-(void)stopWifiSharing:(BOOL)isClear
{
    if(isClear &amp;&amp; self.mySession != nil){
        [self.mySession disconnect];

        [self.mySession setDelegate:nil];

        self.mySession = nil;

        self.browserVC = nil;
    }
}  
</code></pre>

<h6 id="mcbrowserviewcontroller-代理方法"><code>MCBrowserViewController</code> 代理方法</h6>

<pre><code>#pragma marks MCBrowserViewControllerDelegate
// 点击完成
-(void)browserViewControllerDidFinish:(MCBrowserViewController *)browserViewController
{
    [self dismissBrowserVC];
    [marrReceiveData removeAllObjects];
}

// 点击取消
-(void)browserViewControllerWasCancelled:(MCBrowserViewController *)browserViewController
{
    [self dismissBrowserVC];
}
</code></pre>

<h6 id="mcsession代理方法">MCSession代理方法</h6>

<blockquote>
<p>主要处理发送方传递的文件或者信息</p>
</blockquote>

<pre><code>// Received data from remote peer
- (void)session:(MCSession *)session didReceiveData:(NSData *)data fromPeer:(MCPeerID *)peerID
{
    NSLog(@&quot;data receiveddddd : %lu&quot;,(unsigned long)data.length);

    if (data.length &gt; 0) {
        if (data.length &lt; 2) {
            noOfDataSend++;
            NSLog(@&quot;noofdatasend : %zd&quot;,noOfDataSend);
            NSLog(@&quot;array count : %zd&quot;,marrFileData.count);
            if (noOfDataSend &lt; ([marrFileData count])) {
                [self.mySession sendData:[marrFileData objectAtIndex:noOfDataSend] toPeers:[self.mySession connectedPeers] withMode:MCSessionSendDataReliable error:nil];
            }else {
                [self.mySession sendData:[@&quot;File Transfer Done&quot; dataUsingEncoding:NSUTF8StringEncoding] toPeers:[self.mySession connectedPeers] withMode:MCSessionSendDataReliable error:nil];
            }
        } else {
            if ([[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding] isEqualToString:@&quot;File Transfer Done&quot;]) {
                [self appendFileData];
            }else {
                [self.mySession sendData:[@&quot;1&quot; dataUsingEncoding:NSUTF8StringEncoding] toPeers:[self.mySession connectedPeers] withMode:MCSessionSendDataReliable error:nil];
                [marrReceiveData addObject:data];
            }
        }
    }
}

// Received a byte stream from remote peer
- (void)session:(MCSession *)session didReceiveStream:(NSInputStream *)stream withName:(NSString *)streamName fromPeer:(MCPeerID *)peerID
{
    NSLog(@&quot;did receive stream&quot;);
}

// Start receiving a resource from remote peer
- (void)session:(MCSession *)session didStartReceivingResourceWithName:(NSString *)resourceName fromPeer:(MCPeerID *)peerID withProgress:(NSProgress *)progress
{
    NSLog(@&quot;start receiving&quot;);
}

// Finished receiving a resource from remote peer and saved the content in a temporary location - the app is responsible for moving the file to a permanent location within its sandbox
- (void)session:(MCSession *)session didFinishReceivingResourceWithName:(NSString *)resourceName fromPeer:(MCPeerID *)peerID atURL:(NSURL *)localURL withError:(NSError *)error
{
    NSLog(@&quot;finish receiving resource&quot;);
}

-(void)session:(MCSession *)session peer:(MCPeerID *)peerID didChangeState:(MCSessionState)state
{
    NSLog(@&quot;change state : %zd&quot;,state);
}
</code></pre>

<h6 id="发送图片-此demo只是简单地做了个收发图片的demo-此框架可实现的功能当然不止这么简单">发送图片（此Demo只是简单地做了个收发图片的Demo，此框架可实现的功能当然不止这么简单。）</h6>

<pre><code>-(void)sendData
{
    [marrFileData removeAllObjects];

    NSData *sendData = UIImagePNGRepresentation([UIImage imageNamed:@&quot;test2.png&quot;]);
    NSUInteger length = [sendData length];
    NSUInteger chunkSize = 100 * 1024;
    NSUInteger offset = 0;
    do {
        NSUInteger thisChunkSize = length - offset &gt; chunkSize ? chunkSize : length - offset;
        NSData* chunk = [NSData dataWithBytesNoCopy:(char *)[sendData bytes] + offset
                                             length:thisChunkSize
                                       freeWhenDone:NO];
        NSLog(@&quot;chunk length : %lu&quot;,(unsigned long)chunk.length);

        [marrFileData addObject:[NSData dataWithData:chunk]];
        offset += thisChunkSize;
    } while (offset &lt; length);

    noOfdata = [marrFileData count];
    noOfDataSend = 0;

    if ([marrFileData count] &gt; 0) {
        [self.mySession sendData:[marrFileData objectAtIndex:noOfDataSend] toPeers:[self.mySession connectedPeers] withMode:MCSessionSendDataReliable error:nil];
    }
}

-(void)appendFileData
{
    NSMutableData *fileData = [NSMutableData data];

    for (int i = 0; i &lt; [marrReceiveData count]; i++) {
        [fileData appendData:[marrReceiveData objectAtIndex:i]];
    }

    [fileData writeToFile:[NSString stringWithFormat:@&quot;%@/Image.png&quot;, [NSHomeDirectory() stringByAppendingPathComponent:@&quot;Documents&quot;]] atomically:YES];

    UIImageWriteToSavedPhotosAlbum([UIImage imageWithData:fileData], self, @selector(image:didFinishSavingWithError:contextInfo:), nil);
}

- (void)image:(UIImage *)image didFinishSavingWithError:(NSError *)error contextInfo:(void *)contextInfo
{
    if (!error) {
        [self invokeAlertMethod:@&quot;发送成功&quot; Body:@&quot;图片已保存到手机相册&quot; Delegate:nil];
    }
}
</code></pre>

<p>您可在<a href="https://github.com/brasbug/WiFiShare.git">Github</a>上下载完整Demo。</p>

<p><a href="http://www.jianshu.com/p/f198bbe98014"><strong>转载from</strong></a></p>
</div>

  <footer class="article-footer">
    
    
    
    <section class="bordered">
      <header>
        <div class="panel-title">CATEGORIES</div>
      </header>
      <div>
        <ul class="p-terms">
          
          <li><a href="http://blog.flywithme.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></li>
          
        </ul>
      </div>
    </section>
    
    
    
    
  </footer>

</article>


    
  </div>

  <div class="col-md-4">
    
<aside class="l-sidebar">

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">LATESTS</div>
    </div>
    <div class="list-group">
      
      <a href="http://blog.flywithme.top/2019/02/24/gobin/" class="list-group-item">go bin执行问题记录</a>
      
      <a href="http://blog.flywithme.top/2019/01/15/nginx/" class="list-group-item">Nginx 配置 HTTPS 服务器</a>
      
      <a href="http://blog.flywithme.top/2019/01/13/mongodump/" class="list-group-item">mongodb 维护小记</a>
      
      <a href="http://blog.flywithme.top/2018/12/24/vue_webserver/" class="list-group-item">Vue上线后，history页面点击刷新按钮报错404问题</a>
      
      <a href="http://blog.flywithme.top/2018/12/24/vue-element02/" class="list-group-item">vue 路由重载之后导致history页面刷新空白问题fix</a>
      
      <a href="http://blog.flywithme.top/2018/12/22/vue-element-admin01/" class="list-group-item">vue-element-admin 踩坑日记 01</a>
      
      <a href="http://blog.flywithme.top/2018/12/18/blocked-by-CORS-policy/" class="list-group-item">gin api 跨域问题,cors</a>
      
      <a href="http://blog.flywithme.top/2018/12/10/mongodb/" class="list-group-item">MongoDB 用户名密码登录</a>
      
      <a href="http://blog.flywithme.top/2018/08/31/nat/" class="list-group-item">nat</a>
      
      <a href="http://blog.flywithme.top/2018/04/02/note_28/" class="list-group-item">Elasticsearch 入门</a>
      
    </div>
  </section>

  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">CATEGORY</div>
    </div>
    <div class="list-group">
      
      <a href="http://blog.flywithme.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0" class="list-group-item">技术文章</a>
      
      <a href="http://blog.flywithme.top/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" class="list-group-item">学习笔记</a>
      
      <a href="http://blog.flywithme.top/categories/%E6%80%9D%E8%80%83%E6%84%9F%E6%82%9F" class="list-group-item">思考感悟</a>
      
      <a href="http://blog.flywithme.top/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0" class="list-group-item">读书笔记</a>
      
    </div>
  </section>
  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">TAG</div>
    </div>
    <div class="list-group">
      
    </div>
  </section>
  

</aside>


  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="container">
        <p>Copyright (c) 2016. All rights reserved.</p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_beg">Beg</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

